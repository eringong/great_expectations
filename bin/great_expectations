#!/usr/bin/env python

import argh
import json

#!!! This is a hack to allow testing of this CLT without
#!!! re-installing great_expectations every time there's an edit
import sys
import os 
dir_path = os.path.dirname(os.path.realpath(__file__))
sys.path.append(dir_path+'/..')

import great_expectations as ge

def initialize():
	raise NotImplementedError()

@argh.arg('data_set')
@argh.arg('expectations_config_file')
@argh.arg('--only_show_failures', '-f', default=False)
@argh.arg('--output_format', '-o', default="BASIC")
@argh.arg('--custom_dataset_module', '-m', default=None)
@argh.arg('--custom_dataset_class', '-c', default=None)
def validate(data_set, expectations_config_file, **kwargs):
	expectations_config = json.load(file(expectations_config_file))

	df = ge.read_csv(data_set, expectations_config=expectations_config)

	result = df.validate(
		output_format=kwargs["output_format"]
	)

	if kwargs["only_show_failures"]:
		abbrev_results = []
		for exp in result["results"]:
			if exp["success"]==False:
				abbrev_results.append(exp)
		result["results"] = abbrev_results

	print(json.dumps(result, indent=2))

argh.dispatch_commands([
	initialize,
	validate,
])